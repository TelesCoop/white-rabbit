{% extends "base.html" %}
{% load white_rabbit_tags %}
{% load cache %}
{% load static %}

{% block content %}
  <div class="border-b border-gray-200">
    <nav aria-label="Tabs" role="tablist">
      {% for period in periods %}
        <a type="button"
           href="{% url 'projects' period.key %}"
           class="tab {% if current_period_key == period.key %}text-base font-bold{% endif %}"
           id="tabs-with-badges-item-{{ period.key | slugify }}"
           data-hs-tab="#tabs-with-badges-{{ period.key | slugify }}"
           aria-controls="tabs-with-badges-{{ period.key | slugify }}"
           role="tab">
          {% if period.label %}
            {{ period.label|title }}
          {% else %}
            {{ period.key|format_date }}
          {% endif %}
        </a>
      {% endfor %}
    </nav>
  </div>

  {% for period in periods %}

    <div id="tabs-with-badges-{{ period.key | slugify }}"
         role="tabpanel"
         class="{% if forloop.counter > 1 %}hidden{% endif %}"
         aria-labelledby="tabs-with-badges-item-{{ period.key | slugify }}"
    >
      <table
          class="table border border-gray-200 border-separate rounded-lg divide-y divide-gray-200">
        <thead>

        <tr class="font-bold bg-indigo-50 text-bold text-md">
          <th>
            Employé·e
          </th>
          {% for category in categories %}
            <th>
              {{ category.1 }}
            </th>
          {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for employee, events_by_month_and_category in projects.items %}
          <tr>
            <th class="font-bold bg-gray-100 left-0 sticky z-50 text-center uppercase">
              {{ employee }}
            </th>
            {% for month, events_by_categories in  events_by_month_and_category.items %}
              {% for category in categories %}
                {% if month == period.key %}
                  <td class="min-w-[150px]">
                    {% with events_by_categories|get_events_by_category:category.0 as usr_events_by_categories %}
                      {% if usr_events_by_categories %}
                        <div tabindex="0" class="collapse ">
                          <div class="collapse-title">
                            {{ usr_events_by_categories.days_spent|floatformat:1 }}
                            jour{{ usr_events_by_categories.days_spent|pluralize:'s' }}
                          </div>
                          <div class="collapse-content bg-gray-100 p-2 rounded-xl">
                            <ul>
                              {% for event in usr_events_by_categories.events %}
                                <li class="">
                                  <span>{{ event.name }},</span>
                                  <span>{{ event.duration|floatformat:1 }}h</span> le
                                  <span>{{ event.start_datetime|date:"d/m/Y" }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                      {% endif %}
                    {% endwith %}
                  </td>

                {% endif %}

              {% endfor %}
            {% endfor %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
{% endblock %}
