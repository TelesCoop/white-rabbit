{% extends "base.html" %}
{% load white_rabbit_tags %}
{% load cache %}
{% load static %}

{% block content %}
    <h1 class="text-2xl font-bold mb-4 text-left">
        Total par projet
    </h1>
    <div class="border-b border-gray-200">
        <nav class="flex space-x-1 overflow-x-auto" aria-label="Tabs" role="tablist">
            {% for period in periods %}
                <button type="button"
                        class="hs-tab-active:font-semibold hs-tab-active:border-blue-600 hs-tab-active:text-blue-600 py-4 px-1 inline-flex items-center gap-x-2 border-b-2 border-transparent text-sm whitespace-nowrap text-gray-500 hover:text-blue-600 focus:outline-none focus:text-blue-600 disabled:opacity-50 disabled:pointer-events-none active"
                        id="tabs-with-badges-item-{{ period.key | slugify }}"
                        data-hs-tab="#tabs-with-badges-{{ period.key | slugify }}"
                        aria-controls="tabs-with-badges-{{ period.key | slugify }}"
                        role="tab">
                    {% if period.key != "total" %}
                        {{ period.key|format_date }}
                    {% else %}
                        {{ period.key|title }}
                    {% endif %}
                </button>
            {% endfor %}
        </nav>
    </div>
    <div class="mt-3">
        {% for period in periods %}
            <div id="tabs-with-badges-{{ period.key | slugify }}"
                 role="tabpanel"
                 class="{% if forloop.counter > 1 %}hidden{% endif %}"
                 aria-labelledby="tabs-with-badges-item-{{ period.key | slugify }}"
            >
                <h3 class="text-xl p-4 font-bold">
                    {% if period.key != "total" %}{{ period.key|format_date }}{% endif %}</h3>
                <table class="border border-gray-200 border-separate rounded-lg divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr class="font-bold bg-indigo-50 text-black uppercase text-xs">
                        <th class="p-4 sticky z-50 left-0 bg-indigo-50 w-[150px]">Nom du projet</th>
                        <th class="p-4 sticky z-50 left-[120px] bg-indigo-50">Total</th>
                        {% if period.key == "total" %}
                            <th class="p-4 sticky z-50 left-[270px] bg-indigo-50">Total effectuée</th>
                            <th class="p-4 sticky z-50 left-[420px] bg-indigo-50">Total à faire</th>
                        {% endif %}
                        {% for employee_name in employees_names %}
                            <th class="p-4 text-gray-800">
                                {{ employee_name }}
                            </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    {% for month, events_per_projects_ids in employees_events_per_month.items %}
                        {% if month == period.key %}
                            {% for project_id, employees_events_per_project in events_per_projects_ids.items %}
                                <tr>
                                    <th scope="row"
                                        class="font-bold bg-gray-100 left-0 sticky z-50 uppercase text-sm">
                                        {{ project_id|find_project_name:projects_details }}
                                    </th>
                                    <td class="sticky left-[120px] min-w-[150px] z-50 bg-white text-center">
                                        {{ employees_events_per_project.days|floatformat:1 }}
                                        jour{{ employees_events_per_project.days|pluralize:'s' }}
                                    </td>
                                    {% if period.key == "total" %}
                                        <td class="sticky left-[270px] min-w-[150px] z-50 bg-white text-center">
                                            {{ employees_events_per_project.days_done.total|floatformat:1 }}
                                            jour{{ employees_events_per_project.days_done.total|pluralize:'s' }}

                                        </td>
                                        <td class="sticky left-[420px] min-w-[150px] z-50 bg-white text-center">
                                            {% if  employees_events_per_project.days_todo.total > 0 %}
                                                <div tabindex="0" class="collapse text-center">
                                                    <div class="collapse-title">
                                                        {{ employees_events_per_project.days_todo.total|floatformat:1 }}
                                                        jour{{ employees_events_per_project.days_todo.total|pluralize:'s' }}
                                                    </div>
                                                    <div class="collapse-content bg-gray-100 min-w-[150px] rounded-xl">
                                                        <ul>
                                                            {% for event in employees_events_per_project.days_todo.events %}
                                                                <li>
                                                                    <span>{{ event.duration|floatformat:1 }}h</span> le
                                                                    <span>{{ event.start_datetime|date:"d/m/Y" }}</span>
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    {% for employee_name in employees_names %}
                                        <td>
                                            {% with employees_events_per_project.events|get_employee_events:employee_name as employee_events %}
                                                <div tabindex="0" class="collapse text-center">
                                                    <div class="collapse-title">
                                                        {% if employee_events.days_spent %}
                                                            {{ employee_events.days_spent|floatformat:1 }}
                                                            jour{{ employee_events.days_spent|pluralize:'s' }}
                                                        {% endif %}

                                                    </div>
                                                    <div class="collapse-content bg-gray-100 min-w-[150px] rounded-xl">
                                                        <ul>

                                                            {% for event in employee_events.events %}
                                                                <li>
                                                                    <span>{{ event.duration|floatformat:1 }}h</span> le
                                                                    <span>{{ event.start_datetime|date:"d/m/Y" }}</span>
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            {% endwith %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% endif %}

                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    </div>
{% endblock %}