{% extends "base.html" %}
{% load white_rabbit_tags %}
{% load cache %}
{% load static %}

{% block extra_css %}
.project-time td {
  text-align: center;
  padding: 0.2rem;
}
.forecast-header:first-of-type {
  display: table-row !important;
}


/* Forecast elements */
.forecast-element {
  transition: opacity 0.3s ease;
}
.forecast-hidden .forecast-element {
  display: none;
}
td.availability_without_forecast{
  display: none;
}
.forecast-hidden td.availability_with_forecast {
  display: none;
}
.forecast-hidden td.availability_without_forecast {
  display: table-cell;
}
{% endblock %}

{% block content %}
  <div class="w-[80vw] rounded-xl">
    <!-- Checkbox for forecast projects -->
    <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <label class="flex items-center cursor-pointer">
        <input type="checkbox" id="show-forecast" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" checked>
        <span class="ml-3 text-sm font-medium text-gray-700">
          Afficher les projets prévisionnels
        </span>
      </label>
    </div>

    <table
        class="table border border-gray-200 border-separate rounded-lg divide-y divide-gray-200">
      <thead>
      <tr class="font-bold bg-indigo-50 text-bold text-md">
        <th class="font-bold text-black left-0 top-0 sticky z-150 bg-indigo-50 flex"
            scope="col">
          Salarié·e
        </th>
        {% for period in periods_per_key.values %}
          <th class="min-w-48 font-bold bg-indigo-50 top-0 sticky z-10">
            {% if period.start and period.end %}
              <p class="text-black">{{ period.start }} - {{ period.end }}</p>
            {% endif %}

            <span class="uppercase text-gray-500 font-bold">
              {% if periodicity == "week" %}
                Semaine n°
              {% endif %}
              {{ period.key }}
            </span>
          </th>
        {% endfor %}
      </tr>
      </thead>

      <tbody>
      {% for employee_name, employee_data  in projects_per_period|dict_items %}
        <tr class="bg-gray-50">
          <th class="font-bold bg-gray-100 left-0 sticky z-50 text-center uppercase">{{ employee_name }}</th>
          {% comment %} forecasts are displayed twice, with and without forecast, and JS/CSS only shows one {% endcomment %}
          {% comment %} inluding forecast {% endcomment %}
          {% for period_key, availability_for_employee_period in availability_with_forecast|get_item:employee_name|dict_items %}
            <td class="h-24 availability_with_forecast">
              <div class="flex flex-col h-full relative py-2 bg-white rounded shadow-sm">
                <div class="w-full h-1/2 flex justify-center items-end">
                  {% if availability_for_employee_period|floatval > 0 %}
                    <div class="bg-green-500 text-black rounded px-3 font-bold flex items-center justify-center" style="{% availability_height availability_for_employee_period is_monthly_hours %}">
                      {{ availability_for_employee_period|floatformat:1 }}
                    </div>
                  {% endif %}
                </div>
                <div class="w-full h-0.5 bg-black"></div>
                <div class="w-full h-1/2 flex justify-center items-start">
                  {% if availability_for_employee_period|floatval < 0 %}
                    <div class="bg-red-500 text-black rounded px-3 font-bold flex items-center justify-center" style="{% availability_height availability_for_employee_period is_monthly_hours %}">
                      {{ availability_for_employee_period|floatformat:1 }}
                    </div>
                  {% endif %}
                </div>
            </td>
          {% endfor %}

          {% comment %} without forecast {% endcomment %}
          {% for period_key, availability_for_employee_period in availability|get_item:employee_name|dict_items %}
            <td class="h-24 availability_without_forecast">
              <div class="flex flex-col h-full relative py-2 bg-white rounded shadow-sm">
                <div class="w-full h-1/2 flex justify-center items-end">
                  {% if availability_for_employee_period|floatval > 0 %}
                    <div class="bg-green-500 text-black rounded px-3 font-bold flex items-center justify-center" style="{% availability_height availability_for_employee_period is_monthly_hours %}">
                      {{ availability_for_employee_period|floatformat:1 }}
                    </div>
                  {% endif %}
                </div>
                <div class="w-full h-0.5 bg-black"></div>
                <div class="w-full h-1/2 flex justify-center items-start">
                  {% if availability_for_employee_period|floatval < 0 %}
                    <div class="bg-red-500 text-black rounded px-3 font-bold flex items-center justify-center" style="{% availability_height availability_for_employee_period is_monthly_hours %}">
                      {{ availability_for_employee_period|floatformat:1 }}
                    </div>
                  {% endif %}
                </div>
            </td>
          {% endfor %}
        </tr>
        <tr>
        </tr>

        {% for project_id, project_data in employee_data|dict_items %}
          {% with project=projects|get_item:project_id %}
            {% if not project.is_forecast %}
              <tr class="bg-gray-50 project-time">
                <td>
                  {{ project_id|find_project_name:projects }}
                </td>
                {% for period_key in periods_per_key %}
                    <td>{{ project_data|get_item:period_key|floatformat:1 }}</td>
                {% endfor %}
              </tr>
            {% endif %}
          {% endwith %}
        {% endfor %}

        {# Forecast projects for this employee #}

      <tr class="forecast-element forecast-header border-t-4 border-green-200">
        <td colspan="100%" class="bg-green-50 text-green-800 font-semibold text-left p-2">
          Projets Prévisionnels
        </td>
      </tr>

        {% for project_id, project_data in employee_data|dict_items %}
          {% with project=projects|get_item:project_id %}
            {% if project.is_forecast %}
              <tr class="forecast-element bg-gray-50 project-time border-l-2 border-green-300" data-project-id="{{ project_id }}">
                <td>
                  {{ project_id|find_project_name:projects }}
                  <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full font-medium">Prévision</span>
                </td>
                {% for period_key in periods_per_key %}
                    <td class="text-green-700 font-medium forecast-value"
                        data-period="{{ period_key }}"
                        data-value="{{ project_data|get_item:period_key|default:0 }}">
                      {{ project_data|get_item:period_key|floatformat:1 }}
                    </td>
                {% endfor %}
              </tr>
            {% endif %}
          {% endwith %}
        {% endfor %}
      {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.getElementById('show-forecast');
      const table = document.querySelector('table');

      // Store original availability values
      const originalAvailability = new Map();

      toggle.addEventListener('change', function() {
        if (this.checked) {
          // Show forecast projects
          table.classList.remove('forecast-hidden');
        } else {
          // Hide forecast projects
          table.classList.add('forecast-hidden');
        }
      });
    });
  </script>
{% endblock %}
